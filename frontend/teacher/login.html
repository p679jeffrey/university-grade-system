<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¸«ç®¡ç†ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 280px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .course-list { flex: 1; overflow-y: auto; padding: 10px; }
        .course-item { background: rgba(255,255,255,0.1); padding: 15px; margin: 8px 0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .course-item:hover { background: rgba(255,255,255,0.2); }
        .course-item.active { background: rgba(255,255,255,0.3); border-left: 4px solid white; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 12px; margin: 10px; border-radius: 8px; cursor: pointer; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; background: #f5f7fa; }
        .topbar { background: white; padding: 20px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tabs { display: flex; background: white; border-bottom: 2px solid #e0e0e0; }
        .tab { padding: 15px 30px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; }
        .form-group textarea { min-height: 100px; }
        
        .item { background: #f9f9f9; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #667eea; }
        .item-header { display: flex; justify-content: space-between; align-items: center; }
        .item-actions { display: flex; gap: 8px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f5f5f5; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ğŸ“ èª²ç¨‹ç®¡ç†</h2>
            <p id="teacherName"></p>
        </div>
        <div class="course-list" id="courseList"></div>
        <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h1 id="courseTitle">è«‹é¸æ“‡èª²ç¨‹</h1>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('students')">ğŸ“‹ å­¸ç”Ÿ</div>
            <div class="tab" onclick="switchTab('announcements')">ğŸ“¢ å…¬å‘Š</div>
            <div class="tab" onclick="switchTab('materials')">ğŸ“š æ•™æ</div>
            <div class="tab" onclick="switchTab('assignments')">ğŸ“ ä½œæ¥­</div>
            <div class="tab" onclick="switchTab('grades')">ğŸ“Š æˆç¸¾</div>
        </div>

        <div class="content-area">
            <div id="tab-students" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h3>å­¸ç”Ÿåå–®</h3>
                        <button class="btn btn-primary" onclick="showAddStudentModal()">â• æ–°å¢å­¸ç”Ÿ</button>
                    </div>
                    <table>
                        <thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="studentList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-announcements" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3>èª²ç¨‹å…¬å‘Š</h3>
                        <button class="btn btn-primary" onclick="showAnnouncementModal()">â• æ–°å¢å…¬å‘Š</button>
                    </div>
                    <div id="announcementList"></div>
                </div>
            </div>

            <div id="tab-materials" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3>èª²ç¨‹æ•™æ</h3>
                        <button class="btn btn-primary" onclick="showMaterialModal()">â• ä¸Šå‚³æ•™æ</button>
                    </div>
                    <div id="materialList"></div>
                </div>
            </div>

            <div id="tab-assignments" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3>èª²ç¨‹ä½œæ¥­</h3>
                        <button class="btn btn-primary" onclick="showAssignmentModal()">â• æ–°å¢ä½œæ¥­</button>
                    </div>
                    <div id="assignmentList"></div>
                </div>
            </div>

            <div id="tab-grades" class="tab-content">
                <div class="card">
                    <div class="card-header"><h3>æˆç¸¾ç®¡ç†</h3></div>
                    <table>
                        <thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th><th>æˆç¸¾</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="gradeList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡† -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢å…¬å‘Š</h3>
            <div class="form-group">
                <label>æ¨™é¡Œ</label>
                <input type="text" id="announcementTitle">
            </div>
            <div class="form-group">
                <label>å…§å®¹</label>
                <textarea id="announcementContent"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveAnnouncement()">ç™¼å¸ƒ</button>
            <button class="btn" onclick="closeModal('announcementModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="materialModal" class="modal">
        <div class="modal-content">
            <h3>ä¸Šå‚³æ•™æ</h3>
            <div class="form-group">
                <label>æ•™æåç¨±</label>
                <input type="text" id="materialTitle">
            </div>
            <div class="form-group">
                <label>èªªæ˜</label>
                <textarea id="materialDescription"></textarea>
            </div>
            <div class="form-group">
                <label>æª”æ¡ˆ</label>
                <input type="file" id="materialFile">
            </div>
            <button class="btn btn-primary" onclick="uploadMaterial()">ä¸Šå‚³</button>
            <button class="btn" onclick="closeModal('materialModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢ä½œæ¥­</h3>
            <div class="form-group">
                <label>æ¨™é¡Œ</label>
                <input type="text" id="assignmentTitle">
            </div>
            <div class="form-group">
                <label>èªªæ˜</label>
                <textarea id="assignmentDescription"></textarea>
            </div>
            <div class="form-group">
                <label>æˆªæ­¢æ—¥æœŸ</label>
                <input type="datetime-local" id="assignmentDueDate">
            </div>
            <button class="btn btn-primary" onclick="saveAssignment()">å»ºç«‹</button>
            <button class="btn" onclick="closeModal('assignmentModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢å­¸ç”Ÿ</h3>
            <div class="form-group">
                <label>é¸æ“‡å­¸ç”Ÿ</label>
                <select id="studentSelect" style="width:100%; padding:10px;"></select>
            </div>
            <button class="btn btn-primary" onclick="addStudentToCourse()">ç¢ºèª</button>
            <button class="btn" onclick="closeModal('addStudentModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000';
        let teacher = null;
        let course = null;

        window.onload = function() {
            teacher = JSON.parse(localStorage.getItem('currentTeacher') || 'null');
            if (!teacher) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('teacherName').textContent = teacher.name;
            loadCourses();
        };

        function loadCourses() {
            fetch(`${API}/teacher/${teacher.teacher_id}/courses`)
                .then(r => r.json())
                .then(courses => {
                    document.getElementById('courseList').innerHTML = courses.map(c => `
                        <div class="course-item" onclick="selectCourse(${c.courseId}, '${c.courseName}')">
                            <h4>${c.courseName}</h4>
                            <p>èª²ç¨‹ ${c.courseId}</p>
                        </div>
                    `).join('') || '<p style="padding:20px; text-align:center;">å°šç„¡èª²ç¨‹</p>';
                });
        }

        function selectCourse(id, name) {
            course = { courseId: id, courseName: name };
            document.getElementById('courseTitle').textContent = name;
            document.querySelectorAll('.course-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.course-item').classList.add('active');
            loadStudents();
            loadAnnouncements();
            loadMaterials();
            loadAssignments();
            loadGrades();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
        }

        function logout() {
            localStorage.removeItem('currentTeacher');
            window.location.href = 'login.html';
        }

        function loadStudents() {
            if (!course) return;
            fetch(`${API}/courses/${course.courseId}/students`)
                .then(r => r.json())
                .then(students => {
                    document.getElementById('studentList').innerHTML = students.map(s => `
                        <tr><td>${s.student_id}</td><td>${s.name}</td><td><button class="btn btn-danger btn-small">ç§»é™¤</button></td></tr>
                    `).join('') || '<tr><td colspan="3" style="text-align:center; padding:20px;">å°šç„¡å­¸ç”Ÿ</td></tr>';
                });
        }

        function showAddStudentModal() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            fetch(`${API}/students`)
                .then(r => r.json())
                .then(students => {
                    document.getElementById('studentSelect').innerHTML = students.map(s => 
                        `<option value="${s.studentId}">${s.studentId} - ${s.name}</option>`
                    ).join('');
                    document.getElementById('addStudentModal').classList.add('active');
                });
        }

        function addStudentToCourse() {
            fetch(`${API}/api/courses/${course.courseId}/students`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId: document.getElementById('studentSelect').value })
            })
            .then(r => r.json())
            .then(() => {
                alert('å­¸ç”ŸåŠ å…¥æˆåŠŸ!');
                closeModal('addStudentModal');
                loadStudents();
            })
            .catch(err => alert('åŠ å…¥å¤±æ•—'));
        }

        function loadAnnouncements() {
            if (!course) return;
            fetch(`${API}/api/courses/${course.courseId}/announcements`)
                .then(r => r.json())
                .then(announcements => {
                    document.getElementById('announcementList').innerHTML = announcements.map(a => `
                        <div class="item">
                            <div class="item-header">
                                <strong>${a.title}</strong>
                                <div class="item-actions">
                                    <button class="btn btn-danger btn-small" onclick="deleteAnnouncement(${a.id})">åˆªé™¤</button>
                                </div>
                            </div>
                            <p>${a.content}</p>
                            <small style="color:#999;">${new Date(a.createdAt).toLocaleString()}</small>
                        </div>
                    `).join('') || '<p style="padding:20px; text-align:center; color:#999;">å°šç„¡å…¬å‘Š</p>';
                });
        }

        function showAnnouncementModal() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementModal').classList.add('active');
        }

        function saveAnnouncement() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            fetch(`${API}/api/courses/${course.courseId}/announcements`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: document.getElementById('announcementTitle').value,
                    content: document.getElementById('announcementContent').value
                })
            })
            .then(() => {
                alert('å…¬å‘Šç™¼å¸ƒæˆåŠŸ!');
                closeModal('announcementModal');
                loadAnnouncements();
            });
        }

        function deleteAnnouncement(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤?')) return;
            fetch(`${API}/api/courses/announcements/${id}`, { method: 'DELETE' })
                .then(() => {
                    alert('åˆªé™¤æˆåŠŸ!');
                    loadAnnouncements();
                });
        }

        function loadMaterials() {
            if (!course) return;
            fetch(`${API}/api/courses/${course.courseId}/materials`)
                .then(r => r.json())
                .then(materials => {
                    document.getElementById('materialList').innerHTML = materials.map(m => `
                        <div class="item">
                            <div class="item-header">
                                <strong>${m.title}</strong>
                                <div class="item-actions">
                                    <a href="${API}/api/courses/materials/${m.id}/download" class="btn btn-success btn-small">ä¸‹è¼‰</a>
                                    <button class="btn btn-danger btn-small" onclick="deleteMaterial(${m.id})">åˆªé™¤</button>
                                </div>
                            </div>
                            <p>${m.description}</p>
                            <small style="color:#999;">${m.fileName}</small>
                        </div>
                    `).join('') || '<p style="padding:20px; text-align:center; color:#999;">å°šç„¡æ•™æ</p>';
                });
        }

        function showMaterialModal() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            document.getElementById('materialTitle').value = '';
            document.getElementById('materialDescription').value = '';
            document.getElementById('materialFile').value = '';
            document.getElementById('materialModal').classList.add('active');
        }

        function uploadMaterial() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            const file = document.getElementById('materialFile').files[0];
            if (!file) {
                alert('è«‹é¸æ“‡æª”æ¡ˆ!');
                return;
            }
            const formData = new FormData();
            formData.append('title', document.getElementById('materialTitle').value);
            formData.append('description', document.getElementById('materialDescription').value);
            formData.append('file', document.getElementById('materialFile').files[0]);

            fetch(`${API}/api/courses/${course.courseId}/materials`, {
                method: 'POST',
                body: formData
            })
            .then(() => {
                alert('æ•™æä¸Šå‚³æˆåŠŸ!');
                closeModal('materialModal');
                loadMaterials();
            });
        }

        function deleteMaterial(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤?')) return;
            fetch(`${API}/api/courses/materials/${id}`, { method: 'DELETE' })
                .then(() => {
                    alert('åˆªé™¤æˆåŠŸ!');
                    loadMaterials();
                });
        }

        function loadAssignments() {
            if (!course) return;
            fetch(`${API}/api/courses/${course.courseId}/assignments`)
                .then(r => r.json())
                .then(assignments => {
                    document.getElementById('assignmentList').innerHTML = assignments.map(a => `
                        <div class="item">
                            <div class="item-header">
                                <strong>${a.title}</strong>
                                <div class="item-actions">
                                    <button class="btn btn-small">æŸ¥çœ‹ç¹³äº¤ (${a.submissionCount})</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteAssignment(${a.id})">åˆªé™¤</button>
                                </div>
                            </div>
                            <p>${a.description}</p>
                            <small style="color:#999;">æˆªæ­¢: ${new Date(a.dueDate).toLocaleString()}</small>
                        </div>
                    `).join('') || '<p style="padding:20px; text-align:center; color:#999;">å°šç„¡ä½œæ¥­</p>';
                });
        }

        function showAssignmentModal() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            document.getElementById('assignmentTitle').value = '';
            document.getElementById('assignmentDescription').value = '';
            document.getElementById('assignmentDueDate').value = '';
            document.getElementById('assignmentModal').classList.add('active');
        }

        function saveAssignment() {
            if (!course) {
                alert('è«‹å…ˆé¸æ“‡èª²ç¨‹!');
                return;
            }
            fetch(`${API}/api/courses/${course.courseId}/assignments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: document.getElementById('assignmentTitle').value,
                    description: document.getElementById('assignmentDescription').value,
                    dueDate: document.getElementById('assignmentDueDate').value
                })
            })
            .then(() => {
                alert('ä½œæ¥­å»ºç«‹æˆåŠŸ!');
                closeModal('assignmentModal');
                loadAssignments();
            });
        }

        function deleteAssignment(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤?')) return;
            fetch(`${API}/api/courses/assignments/${id}`, { method: 'DELETE' })
                .then(() => {
                    alert('åˆªé™¤æˆåŠŸ!');
                    loadAssignments();
                });
        }

        function loadGrades() {
            if (!course) return;
            fetch(`${API}/courses/${course.courseId}/students`)
                .then(r => r.json())
                .then(students => {
                    document.getElementById('gradeList').innerHTML = students.map(s => `
                        <tr>
                            <td>${s.student_id}</td>
                            <td>${s.name}</td>
                            <td><input type="number" id="score_${s.student_id}" value="${s.score || ''}" min="0" max="100" style="width:80px; padding:5px;"></td>
                            <td><button class="btn btn-success btn-small" onclick="saveScore('${s.student_id}')">å„²å­˜</button></td>
                        </tr>
                    `).join('');
                });
        }

        function saveScore(studentId) {
            fetch(`${API}/grades`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    course_id: course.courseId,
                    score: parseInt(document.getElementById('score_' + studentId).value)
                })
            })
            .then(() => alert('æˆç¸¾å„²å­˜æˆåŠŸ!'));
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
    </script>
</body>
</html>